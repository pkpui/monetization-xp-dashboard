<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monetization XP Dashboard</title>
  <style>
    :root {
      --bg: #0b0f16;
      --panel: #111827;
      --panel2: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #60a5fa;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #f87171;
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.25), transparent),
                  radial-gradient(900px 600px at 90% 10%, rgba(52,211,153,.14), transparent),
                  var(--bg);
      color: var(--text);
    }
    header {
      padding: 18px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: rgba(11,15,22,.85);
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    header .row {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
      font-weight: 700;
    }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    button {
      background: linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.08));
      border: 1px solid rgba(96,165,250,.35);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
    }
    button.secondary {
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }
    button.danger {
      background: linear-gradient(180deg, rgba(248,113,113,.18), rgba(248,113,113,.08));
      border: 1px solid rgba(248,113,113,.35);
    }
    button:active { transform: translateY(1px); }

    main { max-width: 1100px; margin: 0 auto; padding: 18px 16px 28px; }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(17,24,39,.72));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 14px;
      color: rgba(229,231,235,.95);
    }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 980px) { .kpis { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px) { .kpis { grid-template-columns: 1fr; } }

    .kpi {
      background: linear-gradient(180deg, rgba(15,23,42,.75), rgba(15,23,42,.5));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 22px; font-weight: 800; margin-top: 6px; }
.kpi .hint { font-size: 11px; color: rgba(156,163,175,.9); margin-top: 4px; }

    .xpbar {
      height: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px;
    }
    .xpbar > div {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(52,211,153,.9));
    }

    .row2 { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .mono { font-family: var(--mono); }

    .agents { display: flex; flex-direction: column; gap: 10px; }
    details {
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(15,23,42,.35);
    }
    summary {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      gap: 10px;
      align-items: baseline;
      justify-content: space-between;
      list-style: none;
    }
    summary::-webkit-details-marker { display:none; }
    .agent-title { display: flex; gap: 10px; align-items: baseline; }
    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: rgba(229,231,235,.95);
      background: rgba(255,255,255,.04);
      white-space: nowrap;
    }
    .pill.good { border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.08); }
    .pill.warn { border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.08); }

    .agent-body { padding: 0 12px 12px; }
    .muted { color: var(--muted); font-size: 12px; }

    .tasks { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
    .task {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(17,24,39,.55);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .task .name { font-weight: 700; font-size: 13px; }
    .task .meta { font-size: 11px; color: var(--muted); margin-top: 3px; }

    .controls { display:flex; gap: 6px; }
    .controls button { padding: 6px 8px; border-radius: 10px; font-size: 11px; }

    .form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 760px) { .form { grid-template-columns: 1fr; } }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      padding: 9px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 84px; resize: vertical; }

    .toast {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
      max-width: 96vw;
      font-size: 12px;
    }
    .toast.on { opacity: 1; }

    .small { font-size: 11px; color: rgba(156,163,175,.9); }
    .split { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <h1>Monetization XP Dashboard</h1>
        <div class="sub">Web hosted • persists in your browser (localStorage) • gamified KPIs → XP → Levels</div>
      </div>
      <div class="btns">
        <button class="secondary" id="btnExport">Export JSON</button>
        <button class="secondary" id="btnImport">Import JSON</button>
        <button class="secondary" id="btnCopyDoc">Copy Doc-Ready Summary</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </div>
  </header>

  <main>
<div class="card">
      <div class="split">
        <div>
          <h2 style="margin:0">Goal & XP</h2>
          <div class="muted">Set the goal once, then track KPIs. XP is earned by hitting weekly targets and completing agent tasks.</div>
        </div>
        <div class="mono small" id="lastUpdated"></div>
      </div>

      <div class="form" style="margin-top:12px">
        <div>
          <label>Primary monetization goal (1 line)</label>
          <input id="goalText" placeholder="e.g., $10k/mo: Outbound System Setup + Retainer sold via YouTube + SEO" />
        </div>
        <div>
          <label>Weekly XP target</label>
          <input id="xpTarget" type="number" min="1" step="1" />
        </div>
        <div>
          <label>Current Level</label>
          <input id="level" type="number" min="1" step="1" />
        </div>
        <div>
          <label>Total XP</label>
          <input id="xp" type="number" min="0" step="1" />
        </div>
      </div>

      <div class="xpbar" title="XP progress toward next level"><div id="xpFill"></div></div>
      <div class="small" id="xpHint" style="margin-top:8px"></div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <h2>KPIs (this week)</h2>
        <div class="kpis" id="kpiGrid"></div>

        <div class="form" style="margin-top:12px">
          <div>
            <label>Add KPI</label>
            <input id="newKpiName" placeholder="e.g., Cold emails sent" />
          </div>
          <div>
            <label>Unit</label>
            <input id="newKpiUnit" placeholder="e.g., count / % / $" />
          </div>
          <div>
            <label>Weekly Target</label>
            <input id="newKpiTarget" type="number" step="any" placeholder="e.g., 250" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="btnAddKpi" style="width:100%">Add KPI</button>
          </div>
        </div>

        <div class="small" style="margin-top:10px">
          Tip: Keep 5–8 KPIs max. If you add too many, the game gets noisy.
        </div>
      </div>

      <div class="card">
        <h2>Agents & Levels</h2>
        <div class="muted">You (main agent) + sub agents + levels under them. Each task can award XP when completed.</div>

        <div class="form" style="margin-top:10px">
          <div>
            <label>New agent / sub-agent name</label>
            <input id="newAgentName" placeholder="e.g., Offer+Copy Agent" />
          </div>
          <div>
            <label>Parent</label>
            <select id="newAgentParent"></select>
          </div>
          <div>
            <label>Role (1 line)</label>
            <input id="newAgentRole" placeholder="e.g., Write sales pages, sequences, scripts" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="btnAddAgent" style="width:100%">Add Agent</button>
          </div>
        </div>

        <div class="agents" id="agents"></div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>
  <input id="fileImport" type="file" accept="application/json" style="display:none" />

  <script>
    const STORAGE_KEY = 'monetization_xp_dashboard_v1';
const defaultState = () => ({
      goalText: 'Reach $10k/mo: Sell Outbound System Setup (48–72h) → convert to monthly Outbound Ops Retainer',
      xpTarget: 100,
      level: 1,
      xp: 0,
      lastUpdated: Date.now(),
      kpis: [
        { id: crypto.randomUUID(), name: 'Qualified leads added', unit: 'count', target: 40, value: 0 },
        { id: crypto.randomUUID(), name: 'Cold emails sent', unit: 'count', target: 250, value: 0 },
        { id: crypto.randomUUID(), name: 'Positive replies', unit: 'count', target: 8, value: 0 },
        { id: crypto.randomUUID(), name: 'Booked calls', unit: 'count', target: 3, value: 0 },
        { id: crypto.randomUUID(), name: 'Content shipped (YT/posts)', unit: 'count', target: 3, value: 0 },
        { id: crypto.randomUUID(), name: 'Revenue', unit: '$', target: 2500, value: 0 },
      ],
      agents: [
        {
          id: 'main',
          name: 'Main Agent (You + System)',
          role: 'Own strategy, decisions, final deliverables, and KPI scoreboard',
          parentId: null,
          level: 1,
          xp: 0,
          tasks: [
            { id: crypto.randomUUID(), name: 'Publish 1 demo (YT or post)', notes: '1 problem → 1 system → CTA', xp: 15, status: 'todo' },
            { id: crypto.randomUUID(), name: 'Ship lead magnet v1', notes: 'Outbound System Build Checklist', xp: 25, status: 'todo' },
          ]
        },
        {
          id: crypto.randomUUID(),
          name: 'Offer + Copy Agent',
          role: 'Sales page, sequences, hooks, landing page copy',
          parentId: 'main',
          level: 1,
          xp: 0,
          tasks: [
            { id: crypto.randomUUID(), name: 'Draft one-page sales page', notes: 'Starter/Growth/Scale tiers + FAQs', xp: 20, status: 'done' },
            { id: crypto.randomUUID(), name: 'Write 3 outbound sequences', notes: '3 angles, 6-touch each', xp: 25, status: 'todo' },
          ]
        },
        {
          id: crypto.randomUUID(),
          name: 'Content Calendar Agent',
          role: '4-week YT+SEO plan, scripts, titles, keywords',
          parentId: 'main',
          level: 1,
          xp: 0,
          tasks: [
            { id: crypto.randomUUID(), name: '4-week calendar drafted', notes: 'Titles, hooks, CTAs, matching blog posts', xp: 20, status: 'done' },
            { id: crypto.randomUUID(), name: 'Write Week 1 scripts', notes: '3 videos with description + pinned comment', xp: 30, status: 'todo' },
          ]
        },
      ]
    });

    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        const parsed = JSON.parse(raw);
        return { ...defaultState(), ...parsed };
      } catch {
        return defaultState();
      }
    }

    function save() {
      state.lastUpdated = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      render();
    }

    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('on');
      setTimeout(() => el.classList.remove('on'), 1600);
    }

    function computeLevelFromXp(xp) {
      let lvl = 1;
      let need = 100;
      let remaining = xp;
      while (remaining >= need) {
        remaining -= need;
        lvl += 1;
        need = Math.floor(need * 1.25 + 10);
        if (lvl > 99) break;
      }
      return { lvl, remaining, need };
    }

    function awardXp(amount, reason) {
      amount = Math.max(0, Math.floor(amount));
      if (!amount) return;
      state.xp += amount;
      const { lvl } = computeLevelFromXp(state.xp);
      state.level = lvl;
      toast(`+${amount} XP — ${reason}`);
      save();
    }

    function kpiXpThisWeek() {
      let total = 0;
      for (const k of state.kpis) {
        const t = Number(k.target) || 0;
        const v = Number(k.value) || 0;
        if (t <= 0) continue;
        const pct = Math.max(0, Math.min(1.5, v / t));
total += Math.min(20, Math.floor(pct * 20));
      }
      return total;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function renderKpis() {
      const grid = document.getElementById('kpiGrid');
      grid.innerHTML = '';
      for (const k of state.kpis) {
        const t = Number(k.target) || 0;
        const v = Number(k.value) || 0;
        const pct = t ? Math.round((v / t) * 100) : 0;
        const color = pct >= 100 ? 'var(--good)' : pct >= 70 ? 'var(--warn)' : 'var(--muted)';

        const el = document.createElement('div');
        el.className = 'kpi';
        el.innerHTML = `
          <div class="label">${escapeHtml(k.name)} <span class="mono" style="float:right;color:${color}">${isFinite(pct)?pct:0}%</span></div>
          <div class="value mono">${escapeHtml(String(v))} <span style="font-size:12px;color:var(--muted)">${escapeHtml(k.unit||'')}</span></div>
          <div class="hint">Target: <span class="mono">${escapeHtml(String(t))}</span>
            <span style="float:right">
              <button class="secondary" data-kpi="${k.id}" data-delta="-1">-</button>
              <button class="secondary" data-kpi="${k.id}" data-delta="1">+</button>
              <button class="secondary" data-kpi-del="${k.id}">Delete</button>
            </span>
          </div>
        `;
        grid.appendChild(el);
      }

      grid.querySelectorAll('button[data-kpi]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-kpi');
          const delta = Number(btn.getAttribute('data-delta'));
          const k = state.kpis.find(x => x.id === id);
          if (!k) return;
          k.value = Number(k.value || 0) + delta;
          save();
        });
      });
      grid.querySelectorAll('button[data-kpi-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-kpi-del');
          state.kpis = state.kpis.filter(x => x.id !== id);
          save();
        });
      });
    }

    function renderAgents() {
      const select = document.getElementById('newAgentParent');
      select.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '(no parent)';
      select.appendChild(opt0);
      for (const a of state.agents) {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        select.appendChild(opt);
      }

      const wrap = document.getElementById('agents');
      wrap.innerHTML = '';

      const byParent = new Map();
      for (const a of state.agents) {
        const key = a.parentId || 'root';
        if (!byParent.has(key)) byParent.set(key, []);
        byParent.get(key).push(a);
      }
      for (const list of byParent.values()) list.sort((x,y)=>x.name.localeCompare(y.name));

      const renderNode = (agent, depth=0) => {
        const done = (agent.tasks||[]).filter(t=>t.status==='done').length;
        const total = (agent.tasks||[]).length;
        const statusPill = total ? (done===total ? ['good','All done'] : done>0 ? ['warn', `${done}/${total} done`] : ['','No progress']) : ['','No tasks'];

        const det = document.createElement('details');
        det.open = depth === 0;
        det.innerHTML = `
          <summary>
            <div class="agent-title">
              <div style="font-weight:800;font-size:13px">${escapeHtml(agent.name)}</div>
              <span class="pill">Lvl <span class="mono">${escapeHtml(String(agent.level||1))}</span></span>
              <span class="pill ${statusPill[0]}">${escapeHtml(statusPill[1])}</span>
            </div>
            <div class="mono small">XP <span class="mono">${escapeHtml(String(agent.xp||0))}</span></div>
          </summary>
<div class="agent-body">
            <div class="muted">${escapeHtml(agent.role||'')}</div>

            <div class="form" style="margin-top:10px">
              <div>
                <label>Add task</label>
                <input data-task-name="${agent.id}" placeholder="e.g., Write Week 1 scripts" />
              </div>
              <div>
                <label>XP</label>
                <input data-task-xp="${agent.id}" type="number" min="0" step="1" value="15" />
              </div>
              <div style="grid-column:1/-1">
                <label>Notes</label>
                <textarea data-task-notes="${agent.id}" placeholder="Definition of done / links / constraints"></textarea>
              </div>
              <div style="grid-column:1/-1">
                <button data-task-add="${agent.id}" style="width:100%">Add Task</button>
              </div>
            </div>

            <div class="tasks" id="tasks-${agent.id}"></div>

            <div class="row2" style="margin-top:10px">
              <div class="small">Agent actions: award XP is global; task XP awards on completion.</div>
              <div class="controls">
                <button class="secondary" data-agent-award="${agent.id}">+10 XP</button>
                <button class="secondary" data-agent-edit="${agent.id}">Edit</button>
                <button class="danger" data-agent-del="${agent.id}">Delete</button>
              </div>
            </div>
          </div>
        `;

        wrap.appendChild(det);

        const taskWrap = det.querySelector(`#tasks-${agent.id}`);
        taskWrap.innerHTML = '';
        for (const t of (agent.tasks||[])) {
          const pill = t.status==='done' ? 'good' : t.status==='doing' ? 'warn' : '';
          const statusLabel = t.status==='done' ? 'DONE' : t.status==='doing' ? 'DOING' : 'TODO';
          const taskEl = document.createElement('div');
          taskEl.className = 'task';
          taskEl.innerHTML = `
            <div>
              <div class="name">${escapeHtml(t.name)} <span class="pill ${pill}" style="margin-left:8px">${statusLabel}</span></div>
              <div class="meta">XP: <span class="mono">${escapeHtml(String(t.xp||0))}</span>${t.notes?` • ${escapeHtml(t.notes)}`:''}</div>
            </div>
            <div class="controls">
              <button class="secondary" data-task-status="todo" data-agent="${agent.id}" data-task="${t.id}">Todo</button>
              <button class="secondary" data-task-status="doing" data-agent="${agent.id}" data-task="${t.id}">Doing</button>
              <button class="secondary" data-task-done="1" data-agent="${agent.id}" data-task="${t.id}">Done +XP</button>
              <button class="danger" data-task-del="1" data-agent="${agent.id}" data-task="${t.id}">Del</button>
            </div>
          `;
          taskWrap.appendChild(taskEl);
        }

        const kids = byParent.get(agent.id) || [];
        for (const kid of kids) renderNode(kid, depth+1);

        det.querySelector(`button[data-task-add="${agent.id}"]`).addEventListener('click', () => {
          const name = det.querySelector(`input[data-task-name="${agent.id}"]`).value.trim();
          const xp = Number(det.querySelector(`input[data-task-xp="${agent.id}"]`).value || 0);
          const notes = det.querySelector(`textarea[data-task-notes="${agent.id}"]`).value.trim();
          if (!name) return toast('Task name required');
          agent.tasks = agent.tasks || [];
          agent.tasks.unshift({ id: crypto.randomUUID(), name, notes, xp: Math.max(0, Math.floor(xp)), status: 'todo' });
          det.querySelector(`input[data-task-name="${agent.id}"]`).value = '';
          det.querySelector(`textarea[data-task-notes="${agent.id}"]`).value = '';
          save();
        });
det.querySelector(`button[data-agent-award="${agent.id}"]`).addEventListener('click', () => {
          agent.xp = (agent.xp||0) + 10;
          awardXp(10, `${agent.name} manual award`);
          agent.level = 1 + Math.floor((agent.xp||0) / 50);
          save();
        });

        det.querySelector(`button[data-agent-edit="${agent.id}"]`).addEventListener('click', () => {
          const newName = prompt('Agent name:', agent.name);
          if (newName === null) return;
          const newRole = prompt('Agent role (1 line):', agent.role || '');
          if (newRole === null) return;
          agent.name = newName.trim() || agent.name;
          agent.role = newRole.trim();
          save();
        });

        det.querySelector(`button[data-agent-del="${agent.id}"]`).addEventListener('click', () => {
          if (!confirm(`Delete agent "${agent.name}" and all its children?`)) return;
          const toDelete = new Set();
          const collect = (id) => {
            toDelete.add(id);
            for (const a of state.agents.filter(x=>x.parentId===id)) collect(a.id);
          };
          collect(agent.id);
          state.agents = state.agents.filter(x => !toDelete.has(x.id));
          save();
        });

        det.querySelectorAll('button[data-task-status]').forEach(btn => {
          btn.addEventListener('click', () => {
            const aid = btn.getAttribute('data-agent');
            const tid = btn.getAttribute('data-task');
            const st = btn.getAttribute('data-task-status');
            const ag = state.agents.find(x=>x.id===aid);
            const task = ag?.tasks?.find(x=>x.id===tid);
            if (!task) return;
            task.status = st;
            save();
          });
        });
        det.querySelectorAll('button[data-task-done]').forEach(btn => {
          btn.addEventListener('click', () => {
            const aid = btn.getAttribute('data-agent');
            const tid = btn.getAttribute('data-task');
            const ag = state.agents.find(x=>x.id===aid);
            const task = ag?.tasks?.find(x=>x.id===tid);
            if (!task) return;
            task.status = 'done';
            const xp = Number(task.xp||0);
            ag.xp = (ag.xp||0) + xp;
            ag.level = 1 + Math.floor((ag.xp||0) / 50);
            awardXp(xp, `${ag.name}: ${task.name}`);
            save();
          });
        });
        det.querySelectorAll('button[data-task-del]').forEach(btn => {
          btn.addEventListener('click', () => {
            const aid = btn.getAttribute('data-agent');
            const tid = btn.getAttribute('data-task');
            const ag = state.agents.find(x=>x.id===aid);
            if (!ag?.tasks) return;
            ag.tasks = ag.tasks.filter(x=>x.id!==tid);
            save();
          });
        });
      };

      const roots = byParent.get('root') || [];
      for (const r of roots) renderNode(r, 0);
    }

    function docReadySummary() {
      const lines = [];
      lines.push('MONETIZATION XP DASHBOARD');
      lines.push('');
      lines.push('Goal: ' + (state.goalText||''));
      lines.push(`Level: ${state.level} | Total XP: ${state.xp} | Weekly XP Target: ${state.xpTarget}`);
      lines.push('');
      lines.push('KPIs (this week):');
      for (const k of state.kpis) {
        lines.push(`- ${k.name}: ${k.value}/${k.target} ${k.unit||''}`.trim());
      }
      lines.push('');
      lines.push('Agents:');
      const byParent = new Map();
      for (const a of state.agents) {
        const key = a.parentId || 'root';
        if (!byParent.has(key)) byParent.set(key, []);
        byParent.get(key).push(a);
      }
      const renderAgent = (a, depth=0) => {
        const indent = '  '.repeat(depth);
        const done = (a.tasks||[]).filter(t=>t.status==='done').length;
        const total = (a.tasks||[]).length;
        lines.push(`${indent}- ${a.name} (Lvl ${a.level||1}, XP ${a.xp||0}) — ${a.role||''}`);
        if (total) {
lines.push(`${indent}  Tasks: ${done}/${total} done`);
          for (const t of (a.tasks||[])) {
            lines.push(`${indent}  - [${t.status==='done'?'x':t.status==='doing'?'~':' '}] ${t.name} (+${t.xp||0} XP)`);
          }
        }
        for (const kid of (byParent.get(a.id)||[])) renderAgent(kid, depth+1);
      };
      for (const root of (byParent.get('root')||[])) renderAgent(root, 0);

      return lines.join('\n');
    }

    // bindings
    let state = load();

    document.getElementById('goalText').addEventListener('input', (e) => { state.goalText = e.target.value; save(); });
    document.getElementById('xpTarget').addEventListener('input', (e) => { state.xpTarget = Number(e.target.value||0); save(); });
    document.getElementById('level').addEventListener('input', (e) => { state.level = Number(e.target.value||1); save(); });
    document.getElementById('xp').addEventListener('input', (e) => { state.xp = Number(e.target.value||0); const { lvl } = computeLevelFromXp(state.xp); state.level = lvl; save(); });

    document.getElementById('btnAddKpi').addEventListener('click', () => {
      const name = document.getElementById('newKpiName').value.trim();
      const unit = document.getElementById('newKpiUnit').value.trim();
      const target = Number(document.getElementById('newKpiTarget').value || 0);
      if (!name) return toast('KPI name required');
      state.kpis.push({ id: crypto.randomUUID(), name, unit, target, value: 0 });
      document.getElementById('newKpiName').value = '';
      document.getElementById('newKpiUnit').value = '';
      document.getElementById('newKpiTarget').value = '';
      save();
    });

    document.getElementById('btnAddAgent').addEventListener('click', () => {
      const name = document.getElementById('newAgentName').value.trim();
      const role = document.getElementById('newAgentRole').value.trim();
      const parentId = document.getElementById('newAgentParent').value || null;
      if (!name) return toast('Agent name required');
      state.agents.push({ id: crypto.randomUUID(), name, role, parentId, level: 1, xp: 0, tasks: [] });
      document.getElementById('newAgentName').value = '';
      document.getElementById('newAgentRole').value = '';
      save();
    });

    document.getElementById('btnCopyDoc').addEventListener('click', async () => {
      await navigator.clipboard.writeText(docReadySummary());
      toast('Copied doc-ready summary');
    });

    document.getElementById('btnExport').addEventListener('click', async () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'monetization-xp-dashboard.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    const fileImport = document.getElementById('fileImport');
    document.getElementById('btnImport').addEventListener('click', () => fileImport.click());
    fileImport.addEventListener('change', async () => {
      const f = fileImport.files?.[0];
      if (!f) return;
      const text = await f.text();
      try {
        const parsed = JSON.parse(text);
        state = { ...defaultState(), ...parsed };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        toast('Imported');
        render();
      } catch {
        toast('Import failed: invalid JSON');
      }
      fileImport.value = '';
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      if (!confirm('Reset dashboard data in this browser?')) return;
      state = defaultState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      toast('Reset');
      render();
    });

    save();
  </script>
</body>
</html>
